<!DOCTYPE html>
<html>
<head>
    <title>Mangrove Detection</title>
</head>
<body style="text-align:center; font-family:sans-serif;">

<h2>ESP32 Mangrove Detection</h2>

<img id="resultImage" width="640"><br><br>

<!-- Resolution Selector -->
Resolution:
<select id="resolutionSelect">
    {% for res in resolutions %}
        <option value="{{ res }}">{{ res }}</option>
    {% endfor %}
</select>
<button onclick="changeResolution()">Apply</button>
<br><br>

<!-- Confidence Slider -->
Confidence:
<input type="range" id="confidenceSlider" min="0.1" max="0.9" step="0.05" value="0.3">
<span id="confValue">0.3</span><br><br>

<!-- Auto Detect -->
Auto Detect Every (seconds):
<input type="number" id="intervalInput" value="5" min="1">
<button onclick="startAutoDetect()">Start</button>
<button onclick="stopAutoDetect()">Stop</button><br><br>

<button onclick="manualDetect()">Run Detection</button>
<button onclick="sendToFirebase()">Send to Firebase</button>

<h3 id="stats"></h3>

<script>

let autoInterval = null;
let lastResult = null;

const slider = document.getElementById("confidenceSlider");
const confValue = document.getElementById("confValue");

slider.oninput = function() {
    confValue.innerText = this.value;
};

async function manualDetect() {
    const confidence = parseFloat(slider.value);

    const response = await fetch("/detect", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({confidence: confidence})
    });

    const data = await response.json();
    lastResult = data;

    document.getElementById("resultImage").src =
        "data:image/jpeg;base64," + data.image;

    document.getElementById("stats").innerText =
        "Detected: " + data.total_detections +
        " | CO2: " + data.carbon.co2_tons + " tons";
}

function startAutoDetect() {
    const seconds = parseInt(document.getElementById("intervalInput").value);
    autoInterval = setInterval(manualDetect, seconds * 1000);
}

function stopAutoDetect() {
    clearInterval(autoInterval);
}

async function changeResolution() {
    const resolution = document.getElementById("resolutionSelect").value;

    await fetch("/set_resolution", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({resolution: resolution})
    });

    alert("Resolution changed");
}

async function sendToFirebase() {
    if (!lastResult) {
        alert("Run detection first");
        return;
    }

    await fetch("/send_to_firebase", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            timestamp: lastResult.timestamp,
            detection_summary: {
                total_mangroves: lastResult.total_detections,
                area_m2: lastResult.carbon.area_m2,
                area_hectares: lastResult.carbon.area_ha
            },
            carbon_sequestration: {
                carbon_stock_tons: lastResult.carbon.carbon_tons,
                co2_equivalent_tons: lastResult.carbon.co2_tons,
                trees_equivalent_per_year: lastResult.carbon.trees
            },
            detections: lastResult.detections,
            source: "esp32_flask_local"
        })
    });

    alert("Sent to Firebase");
}

</script>

</body>
</html>